# -------------------------------
# ðŸ”¹ Base layer
# -------------------------------
FROM node:20-alpine AS base
WORKDIR /app
COPY package*.json ./

# -------------------------------
# ðŸ”¹ Development stage
# -------------------------------
FROM base AS development
RUN npm install
COPY . .
# âœ… Garante que o Prisma seja gerado dentro do container
RUN npx prisma generate
EXPOSE 5000
CMD ["npm", "run", "dev"]

# -------------------------------
# ðŸ”¹ Build stage
# -------------------------------
FROM base AS build
RUN npm ci
COPY . .
# âœ… Gera o cliente Prisma antes do build
RUN npx prisma generate
RUN npm run build

# -------------------------------
# ðŸ”¹ Production stage
# -------------------------------
FROM node:20-alpine AS production
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force
# âœ… Copia o cÃ³digo compilado e a pasta prisma (para migrations e schema)
COPY --from=build /app/dist ./dist
COPY --from=build /app/prisma ./prisma
# âœ… Gera o cliente Prisma em produÃ§Ã£o tambÃ©m (caso o build nÃ£o tenha persistido)
RUN npx prisma generate
EXPOSE 4000
CMD ["npm", "start"]
