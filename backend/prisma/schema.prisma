generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  name           String?
  hashedPassword String?
  oauthProvider  OAuthProvider?
  oauthId        String?        @unique
  role           UserRole       @default(USER)
  emailVerified  Boolean        @default(false)
  isActive       Boolean        @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  billing        Billing?
  cvs            CV[]
  jobImports     JobImport[]
  profile        Profile?
  refreshTokens  RefreshToken[]

  @@index([email])
  @@index([oauthProvider, oauthId])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Profile {
  id              String            @id @default(cuid())
  userId          String            @unique
  headline        String?           @db.VarChar(200)
  summary         String?
  location        String?
  phone           String?
  website         String?
  linkedin        String?
  github          String?
  languages       Json?
  visibility      ProfileVisibility @default(PRIVATE)
  publicSlug      String?           @unique
  profileImageUrl String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  certifications  Certification[]
  educations      Education[]
  experiences     Experience[]
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects        Project[]
  skills          Skill[]

  @@index([publicSlug])
  @@map("profiles")
}

model CV {
  id               String     @id @default(cuid())
  userId           String
  title            String     @db.VarChar(200)
  contentJson      Json
  templateId       String
  status           CVStatus   @default(DRAFT)
  language         CVLanguage @default(PT)
  generatedPdfUrl  String?
  generatedDocxUrl String?
  jobTargetTitle   String?
  jobTargetArea    String?
  isAtsOptimized   Boolean    @default(false)
  viewCount        Int        @default(0)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  targetRole       String?
  aiReviews        AIReview[]
  template         Template   @relation(fields: [templateId], references: [id])
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("cvs")
}

model AIReview {
  id                String   @id @default(cuid())
  cvId              String
  scoreOverall      Float
  scoreAts          Float
  scoreLanguage     Float
  scoreImpact       Float
  scoreClarity      Float
  recommendations   Json
  missingKeywords   String[]
  strengths         String[]
  improvements      String[]
  estimatedReadTime Int?
  createdAt         DateTime @default(now())
  cv                CV       @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@index([cvId])
  @@index([scoreOverall])
  @@map("ai_reviews")
}

model JobImport {
  id              String   @id @default(cuid())
  userId          String
  sourceUrl       String?
  jobTitle        String
  company         String?
  parsedText      String
  extractedSkills String[]
  requirements    Json?
  benefits        Json?
  location        String?
  remoteOption    String?
  salaryRange     String?
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("job_imports")
}

model Billing {
  id                 String             @id @default(cuid())
  userId             String             @unique
  stripeCustomerId   String?            @unique
  subscriptionStatus SubscriptionStatus @default(ACTIVE)
  plan               SubscriptionPlan   @default(FREE)
  subscriptionId     String?            @unique
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean            @default(false)
  cvGenerationLimit  Int                @default(1)
  cvGenerationCount  Int                @default(0)
  lastResetAt        DateTime           @default(now())
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@map("billings")
}

model Experience {
  id          String    @id @default(cuid())
  profileId   String
  jobTitle    String    @db.VarChar(200)
  company     String    @db.VarChar(200)
  location    String?
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean   @default(false)
  description String?
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("experiences")
}

model Education {
  id           String    @id @default(cuid())
  profileId    String
  degree       String    @db.VarChar(200)
  institution  String    @db.VarChar(200)
  fieldOfStudy String?   @db.VarChar(200)
  location     String?
  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean   @default(false)
  grade        String?
  description  String?
  achievements String[]
  sortOrder    Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  profile      Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("educations")
}

model Skill {
  id         String   @id @default(cuid())
  profileId  String
  name       String   @db.VarChar(100)
  category   String?  @db.VarChar(100)
  level      Int?     @default(3)
  yearsOfExp Int?
  isEndorsed Boolean  @default(false)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([category])
  @@map("skills")
}

model Certification {
  id             String    @id @default(cuid())
  profileId      String
  name           String    @db.VarChar(200)
  issuingOrg     String    @db.VarChar(200)
  issueDate      DateTime
  expirationDate DateTime?
  credentialId   String?
  credentialUrl  String?
  doesNotExpire  Boolean   @default(false)
  sortOrder      Int       @default(0)
  createdAt      DateTime  @default(now())
  profile        Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("certifications")
}

model Project {
  id           String    @id @default(cuid())
  profileId    String
  name         String    @db.VarChar(200)
  description  String
  role         String?   @db.VarChar(100)
  startDate    DateTime?
  endDate      DateTime?
  isCurrent    Boolean   @default(false)
  url          String?
  technologies String[]
  highlights   String[]
  sortOrder    Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  profile      Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("projects")
}

model Template {
  id              String        @id @default(cuid())
  name            String
  slug            String        @unique
  description     String?
  metadata        Json?
  createdAt       DateTime      @default(now()) @map("created_at")
  generatedCSS    String?       @map("generated_css")
  generatedHTML   String?       @map("generated_html")
  isActive        Boolean       @default(true) @map("is_active")
  isPremium       Boolean       @default(false) @map("is_premium")
  layoutData      Json?         @map("layout_data")
  previewImageUrl String?       @map("preview_image_url")
  previewUrl      String?       @map("preview_url")
  sortOrder       Int           @default(0) @map("sort_order")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  type            template_type
  cvs             CV[]

  @@map("templates")
}

enum UserRole {
  USER
  ADMIN
  HR_MANAGER
}

enum OAuthProvider {
  GOOGLE
  LINKEDIN
  GITHUB
}

enum ProfileVisibility {
  PRIVATE
  PUBLIC
  UNLISTED
}

enum CVStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CVLanguage {
  PT
  EN
  ES
  FR
  DE
}

enum TemplateType {
  MODERN
  CLASSIC
  CREATIVE
  MINIMAL
  EXECUTIVE
  TECHNICAL
}

enum SubscriptionPlan {
  FREE
  PRO
  CAREER_PLUS
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  EXPIRED
}

enum template_type {
  MODERN
  CLASSIC
  CREATIVE
  MINIMAL
  EXECUTIVE
  TECHNICAL
}
